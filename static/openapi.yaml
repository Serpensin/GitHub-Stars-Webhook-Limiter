openapi: 3.0.3
info:
  title: GitHub Stars Webhook Limiter API
  version: 2.0.0
  description: |
    A Flask application that listens for GitHub webhook events (star/watch), validates them,
    and sends notifications to Discord webhooks if a user performs an action for the first time.
    
    ## Features
    - Validates GitHub webhook secrets using HMAC
    - Prevents duplicate notifications for the same user/repo pair
    - Sends Discord notifications for new stars/watches
    - RESTful API for repository management
    - Admin panel for API key management
    - Rate limiting per API key
    
    ## API Testing
    - **Interactive Testing**: Visit [/try](/try) to test API endpoints with your API key using Swagger UI
    - **Documentation**: Visit [/docs](/docs) for comprehensive API documentation
    - **OpenAPI Spec**: Access the raw specification at [/spec](/spec)
    
    ## Links
    - **Repository**: [GitHub](https://github.com/Serpensin/GitHub-Stars-Webhook-Limiter)
    - **Discord**: [Join our server](https://url.serpensin.com/discord)
  contact:
    name: Serpensin
    url: https://serpensin.com
  license:
    name: AGPL-3.0
    url: https://www.gnu.org/licenses/agpl-3.0.html

servers:
  - url: /
    description: Current server

tags:
  - name: Public API
    description: Public endpoints requiring API key or admin session authentication
  - name: Admin API
    description: Admin endpoints requiring session authentication
  - name: Webhooks
    description: GitHub webhook receiver

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: |
        API key for accessing public endpoints and admin endpoints. 
        
        **For Public API endpoints**: Get your API key from the Admin Panel.
        
        **For Admin API endpoints**: Use an admin API key (created with `is_admin_key: true`).
        
        **Testing**: Click the "Authorize" button above to enter your API key and test endpoints interactively.
    sessionAuth:
      type: apiKey
      in: cookie
      name: session
      description: |
        Admin session cookie (obtain by logging in via /admin/api/login).
        
        Note: When using Swagger UI, admin endpoints can also be accessed using an admin API key in the bearerAuth scheme.

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
      required:
        - error

    Repository:
      type: object
      properties:
        repository_name:
          type: string
          description: GitHub repository in format "owner/repo"
          example: "octocat/Hello-World"
        discord_webhook:
          type: string
          format: uri
          description: Discord webhook URL for notifications
          example: "https://discord.com/api/webhooks/123456789/abcdefg"
        webhook_secret:
          type: string
          description: GitHub webhook secret for signature verification
          example: "my_webhook_secret_123"
      required:
        - repository_name
        - discord_webhook
        - webhook_secret

    RepositoryUpdate:
      type: object
      properties:
        repository_name:
          type: string
          description: GitHub repository in format "owner/repo"
          example: "octocat/Hello-World"
        discord_webhook:
          type: string
          format: uri
          description: New Discord webhook URL (optional)
        webhook_secret:
          type: string
          description: New GitHub webhook secret (optional)
      required:
        - repository_name

    APIKey:
      type: object
      properties:
        id:
          type: integer
          description: Unique API key identifier
        name:
          type: string
          description: Human-readable name for the API key
        permissions:
          type: integer
          description: |
            Permission bitmap:
            - Bit 0 (1): Generate Secret
            - Bit 1 (2): Add Repository
            - Bit 2 (4): Verify Repository
            - Bit 3 (8): Update Repository
            - Bit 4 (16): Delete Repository
            
            Example: 31 = all permissions (1+2+4+8+16)
        rate_limit:
          type: integer
          description: Maximum requests per hour (0 = unlimited)
        is_admin_key:
          type: boolean
          description: Whether this is an admin key with full permissions
        is_active:
          type: boolean
          description: Whether the key is currently active
        created_at:
          type: string
          format: date-time
          description: When the key was created
        last_used:
          type: string
          format: date-time
          nullable: true
          description: When the key was last used (null if never used)

    CreateAPIKey:
      type: object
      properties:
        name:
          type: string
          description: Human-readable name for the API key
          example: "Production API Key"
        permissions:
          type: integer
          description: Permission bitmap (see APIKey schema for details)
          example: 31
          minimum: 0
          maximum: 31
        rate_limit:
          type: integer
          description: Maximum requests per hour (0 = unlimited)
          example: 100
          minimum: 0
        is_admin_key:
          type: boolean
          description: Create as admin key with full permissions
          default: false
      required:
        - name
        - permissions
        - rate_limit

paths:
  # Public API Endpoints
  /api/generate-secret:
    get:
      tags:
        - Public API
      summary: Generate webhook secret
      description: |
        Generate a cryptographically secure random secret for GitHub webhook signature verification.
        
        **Note:** CSRF tokens are automatically handled by the browser when using the web interface. 
        API clients only need to provide the Bearer token in the Authorization header.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Secret generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  secret:
                    type: string
                    description: Generated webhook secret
                    example: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
        '401':
          description: Unauthorized - Invalid or missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Unauthorized: Invalid or missing API key"
        '403':
          description: Forbidden - API key lacks the 'generate-secret' permission (bit 0)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Forbidden: API key does not have permission for this endpoint"
        '429':
          description: Rate limit exceeded - Too many requests from this API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Rate limit exceeded. Try again later."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Database error occurred"

  /api/repositories:
    post:
      tags:
        - Public API
      summary: Add repository
      description: Add a new GitHub repository to track webhook events
      security:
        - bearerAuth: []
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                repo_url:
                  type: string
                  format: uri
                  description: GitHub repository URL
                  example: "https://github.com/octocat/Hello-World"
                secret:
                  type: string
                  description: Webhook secret for signature verification
                  example: "my_webhook_secret_123"
                discord_webhook_url:
                  type: string
                  format: uri
                  description: Discord webhook URL for notifications
                  example: "https://discord.com/api/webhooks/123456789/abcdefg"
                enabled_events:
                  type: string
                  description: Comma-separated list of events to track
                  example: "star,watch"
              required:
                - repo_url
                - secret
                - discord_webhook_url
                - enabled_events
      responses:
        '201':
          description: Repository added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Repository added successfully"
                  repo_full_name:
                    type: string
                    example: "octocat/Hello-World"
        '400':
          description: Bad request - Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - API key lacks permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict - Repository already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      tags:
        - Public API
      summary: Update repository
      description: |
        Update webhook secret, Discord webhook URL, or enabled events for an existing repository.
        
        **Authentication:** Requires the current Discord webhook URL for verification.
        
        **All update fields are optional** - only provide the fields you want to change:
        - `new_secret`: Provide only if you want to change the webhook secret
        - `new_discord_webhook_url`: Provide only if you want to change the Discord webhook URL
        - `enabled_events`: Provide only if you want to change the enabled events
        
        Fields not provided will retain their current values.
      security:
        - bearerAuth: []
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                repository_name:
                  type: string
                  description: GitHub repository in format "owner/repo"
                  example: "octocat/Hello-World"
                discord_webhook_url:
                  type: string
                  format: uri
                  description: Current Discord webhook URL (required for authentication)
                  example: "https://discord.com/api/webhooks/123456789/abcdefg"
                new_secret:
                  type: string
                  description: New webhook secret (optional - only if changing the secret)
                  example: "new_secret_456"
                new_discord_webhook_url:
                  type: string
                  format: uri
                  description: New Discord webhook URL (optional - only if changing the webhook URL)
                  example: "https://discord.com/api/webhooks/987654321/hijklmn"
                enabled_events:
                  type: string
                  description: Comma-separated list of events to track (optional - only if changing events)
                  example: "star,watch"
              required:
                - repository_name
                - discord_webhook_url
      responses:
        '200':
          description: Repository updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Repository updated successfully"
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Repository not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Public API
      summary: Delete repository
      description: Remove a repository from tracking. Requires Discord webhook URL for verification.
      security:
        - bearerAuth: []
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                repository_name:
                  type: string
                  description: GitHub repository in format "owner/repo"
                  example: "octocat/Hello-World"
                discord_webhook_url:
                  type: string
                  format: uri
                  description: Discord webhook URL for verification
                  example: "https://discord.com/api/webhooks/123456789/abcdefg"
              required:
                - repository_name
                - discord_webhook_url
      responses:
        '200':
          description: Repository deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Repository deleted successfully"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Repository not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/repositories/verify:
    post:
      tags:
        - Public API
      summary: Verify and load repository
      description: |
        Check if a repository exists in the database and load its configuration.
        
        **Updated**: No longer requires the webhook secret - only repository URL and Discord webhook URL are needed for verification.
        
        This endpoint is used to load repository configuration for editing without exposing the secret.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                repo_url:
                  type: string
                  format: uri
                  description: GitHub repository URL
                  example: "https://github.com/octocat/Hello-World"
                discord_webhook_url:
                  type: string
                  format: uri
                  description: Discord webhook URL to verify ownership
                  example: "https://discord.com/api/webhooks/123456789/abcdefg"
              required:
                - repo_url
                - discord_webhook_url
      responses:
        '200':
          description: Repository verified and loaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Repository verified"
                  repo_id:
                    type: integer
                    description: Internal repository ID
                    example: 123456789
                  repo_full_name:
                    type: string
                    description: Full repository name (owner/repo)
                    example: "octocat/Hello-World"
                  enabled_events:
                    type: string
                    description: Comma-separated list of enabled events
                    example: "star,watch"
        '400':
          description: Bad request - Invalid input or malformed URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missing_json:
                  value:
                    error: "Missing JSON payload"
                missing_fields:
                  value:
                    error: "Missing required fields"
                invalid_url:
                  value:
                    error: "Invalid GitHub repository URL"
                github_fetch_failed:
                  value:
                    error: "Could not fetch repository data from GitHub"
        '401':
          description: Unauthorized - Invalid or missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - Discord webhook URL does not match stored value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Invalid Discord webhook URL"
        '404':
          description: Repository not found in database
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Repository not found in database"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/events:
    get:
      tags:
        - Public API
      summary: List all available event types
      description: |
        Returns a list of all event types that can be enabled for repository tracking.
        These event names are used when adding or updating repositories in the `enabled_events` field.
        
        **Requires Authentication:** API key or admin session.
      security:
        - bearerAuth: []
        - sessionAuth: []
      responses:
        '200':
          description: List of all available event types
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                          description: Event type name
                          example: "star"
                        description:
                          type: string
                          description: Description of when this event is triggered
                          example: "Triggered when a user stars the repository"
                        github_event:
                          type: string
                          description: Corresponding GitHub webhook event name
                          example: "star"
                  total_events:
                    type: integer
                    description: Total number of available event types
                    example: 2
                  description:
                    type: string
                    description: Usage instructions
                    example: "Use comma-separated event names when adding or updating repositories. Example: 'star,watch'"
              example:
                events:
                  - name: "star"
                    description: "Triggered when a user stars the repository"
                    github_event: "star"
                  - name: "watch"
                    description: "Triggered when a user watches the repository"
                    github_event: "watch"
                total_events: 2
                description: "Use comma-separated event names when adding or updating repositories. Example: 'star,watch'"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/permissions:
    get:
      tags:
        - Public API
      summary: List all available permissions
      description: |
        Returns a list of all available permissions in the system, including their bit positions, 
        numeric values, and descriptions. This is useful for understanding the permission bitmap system
        and for calculating permission values programmatically.
        
        **Requires Authentication:** API key with `permissions-list` permission or admin session.
      security:
        - bearerAuth: []
        - sessionAuth: []
      responses:
        '200':
          description: List of all permissions
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                          description: Permission name
                          example: "repositories-add"
                        bit:
                          type: integer
                          description: Bit position (0-indexed)
                          example: 1
                        value:
                          type: integer
                          description: Numeric value (2^bit)
                          example: 2
                        description:
                          type: string
                          description: Human-readable description
                          example: "Allows adding new repositories"
                  max_value:
                    type: integer
                    description: Maximum possible bitmap value (all permissions enabled)
                    example: 31
                  total_permissions:
                    type: integer
                    description: Total number of permissions
                    example: 8
                  description:
                    type: string
                    description: Explanation of the permission system
                    example: "Permission bitmap system. Combine values with bitwise OR to grant multiple permissions."
              example:
                permissions:
                  - name: "generate-secret"
                    bit: 0
                    value: 1
                    description: "Allows access to /generate-secret endpoint"
                  - name: "repositories-add"
                    bit: 1
                    value: 2
                    description: "Allows access to /repositories (POST) endpoint"
                  - name: "repositories-verify"
                    bit: 2
                    value: 4
                    description: "Allows access to /repositories/verify endpoint"
                  - name: "repositories-update"
                    bit: 3
                    value: 8
                    description: "Allows access to /repositories (PATCH) endpoint"
                  - name: "repositories-delete"
                    bit: 4
                    value: 16
                    description: "Allows access to /repositories (DELETE) endpoint"
                  - name: "events-list"
                    bit: 5
                    value: 32
                    description: "Allows access to /events endpoint"
                  - name: "permissions-list"
                    bit: 6
                    value: 64
                    description: "Allows access to /permissions endpoint"
                  - name: "permissions-calculate"
                    bit: 7
                    value: 128
                    description: "Allows access to /permissions/calculate endpoint"
                  - name: "permissions-decode"
                    bit: 8
                    value: 256
                    description: "Allows access to /permissions/decode endpoint"
                max_value: 511
                total_permissions: 9
                description: "Permission bitmap system. Combine values with bitwise OR to grant multiple permissions."

  /api/permissions/calculate:
    post:
      tags:
        - Public API
      summary: Calculate permission bitmap
      description: |
        Calculates the permission bitmap value from a list of permission names.
        This is a helper endpoint that takes permission names and returns the corresponding
        bitmap value along with a breakdown showing how the value was calculated.
        
        **Requires Authentication:** API key with `permissions-calculate` permission or admin session.
      security:
        - bearerAuth: []
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                permissions:
                  type: array
                  items:
                    type: string
                  description: Array of permission names to calculate bitmap for
                  example: ["repositories-add", "repositories-verify"]
              required:
                - permissions
      responses:
        '200':
          description: Calculated permission bitmap
          content:
            application/json:
              schema:
                type: object
                properties:
                  bitmap:
                    type: integer
                    description: Calculated bitmap value
                    example: 6
                  breakdown:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                          example: "repositories-add"
                        bit:
                          type: integer
                          example: 1
                        value:
                          type: integer
                          example: 2
                    description: Breakdown of each permission's contribution
                  calculation:
                    type: string
                    description: Human-readable calculation formula
                    example: "2 + 4 = 6"
              example:
                bitmap: 6
                breakdown:
                  - name: "repositories-add"
                    bit: 1
                    value: 2
                  - name: "repositories-verify"
                    bit: 2
                    value: 4
                calculation: "2 + 4 = 6"
        '400':
          description: Bad request - Invalid input or unknown permission name
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missing_json:
                  value:
                    error: "Missing JSON payload"
                missing_permissions:
                  value:
                    error: "Missing 'permissions' array in request"
                invalid_type:
                  value:
                    error: "'permissions' must be an array"
                unknown_permission:
                  value:
                    error: "Unknown permission: invalid-permission"

  /api/permissions/decode:
    post:
      tags:
        - Public API
      summary: Decode permission bitmap
      description: |
        Decodes a permission bitmap value to show which permissions are enabled.
        Accepts decimal integers, binary strings (0b prefix), or hexadecimal strings (0x prefix).
        This is useful for understanding what permissions are granted by a specific bitmap value.
        
        **Requires Authentication:** API key with `permissions-decode` permission or admin session.
      security:
        - bearerAuth: []
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                bitmap:
                  oneOf:
                    - type: integer
                      description: Decimal bitmap value
                      example: 6
                    - type: string
                      description: Binary (0b...) or hexadecimal (0x...) string
                      example: "0b110"
              required:
                - bitmap
            examples:
              decimal:
                summary: Decimal value
                value:
                  bitmap: 6
              binary:
                summary: Binary string
                value:
                  bitmap: "0b110"
              hexadecimal:
                summary: Hexadecimal string
                value:
                  bitmap: "0x6"
      responses:
        '200':
          description: Decoded permissions
          content:
            application/json:
              schema:
                type: object
                properties:
                  bitmap:
                    type: integer
                    description: The bitmap value (as decimal)
                    example: 6
                  binary:
                    type: string
                    description: Binary representation
                    example: "0b110"
                  hexadecimal:
                    type: string
                    description: Hexadecimal representation
                    example: "0x6"
                  permissions:
                    type: array
                    items:
                      type: string
                    description: List of enabled permission names
                    example: ["repositories-add", "repositories-verify"]
                  breakdown:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                          example: "repositories-add"
                        bit:
                          type: integer
                          example: 1
                        value:
                          type: integer
                          example: 2
                    description: Breakdown of each enabled permission
                  description:
                    type: string
                    description: Human-readable description
                    example: "Bitmap 6 enables 2 permission(s)"
              example:
                bitmap: 6
                binary: "0b110"
                hexadecimal: "0x6"
                permissions: ["repositories-add", "repositories-verify"]
                breakdown:
                  - name: "repositories-add"
                    bit: 1
                    value: 2
                  - name: "repositories-verify"
                    bit: 2
                    value: 4
                description: "Bitmap 6 enables 2 permission(s)"
        '400':
          description: Bad request - Invalid bitmap format or value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missing_json:
                  value:
                    error: "Missing JSON payload"
                missing_bitmap:
                  value:
                    error: "bitmap value is required"
                invalid_format:
                  value:
                    error: "Invalid bitmap format. Use decimal (3), binary (0b11), or hexadecimal (0x3)"
                negative_value:
                  value:
                    error: "bitmap cannot be negative"
                exceeds_max:
                  value:
                    error: "bitmap value 999 exceeds maximum 31"
                    max_value: 31

  # Admin API Endpoints
  /admin/api/login:
    post:
      tags:
        - Admin API
      summary: Admin login
      description: |
        Authenticate as admin and create a session.
        
        The session cookie is automatically set in the browser via the `Set-Cookie` header.
        For programmatic access (e.g., from scripts or other applications), extract the `session` cookie
        from the response headers and include it in subsequent requests.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                password:
                  type: string
                  format: password
                  description: Admin password
              required:
                - password
            example:
              password: "your_admin_password"
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              description: Session cookie for authentication
              schema:
                type: string
                example: "session=eyJhZG1pbl9hdXRoZW50aWNhdGVkIjp0cnVlfQ...; Path=/; HttpOnly; SameSite=Lax"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Login successful"
                  session_cookie_name:
                    type: string
                    description: Name of the session cookie (always "session")
                    example: "session"
                  session_cookie_value:
                    type: string
                    description: The actual session cookie value for programmatic access
                    example: "eyJhZG1pbl9hdXRoZW50aWNhdGVkIjp0cnVlLCJhZG1pbl9sb2dpbl90aW1lIjoxNjQwOTk1MjAwfQ.YdH3jA.abc123"
        '400':
          description: Bad request - Missing password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Password required"
        '401':
          description: Invalid password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Invalid password"

  /admin/api/logout:
    post:
      tags:
        - Admin API
      summary: Admin logout
      description: End the admin session
      security:
        - sessionAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Logged out successfully"

  /admin/api/keys:
    get:
      tags:
        - Admin API
      summary: List API keys
      description: Get all API keys with their permissions and status
      security:
        - sessionAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      $ref: '#/components/schemas/APIKey'
        '401':
          description: Unauthorized - Session expired or invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags:
        - Admin API
      summary: Create API key
      description: Generate a new API key with specified permissions
      security:
        - sessionAuth: []
          csrfToken: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAPIKey'
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "API key created successfully"
                  api_key:
                    type: string
                    description: The generated API key (only shown once)
                    example: "sk_live_abc123def456..."
                  id:
                    type: integer
                    description: The ID of the created API key
                    example: 42
                  name:
                    type: string
                    example: "Production API Key"
                  permissions:
                    type: integer
                    example: 31
                  rate_limit:
                    type: integer
                    example: 100
                  is_admin_key:
                    type: boolean
                    example: false
        '400':
          description: Bad request - Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                name_required:
                  value:
                    error: "Name required"
                name_too_long:
                  value:
                    error: "Name must be 16 characters or less"
                name_invalid_chars:
                  value:
                    error: "Name can only contain letters, numbers, spaces, hyphens, and underscores"
                no_permissions:
                  value:
                    error: "At least one permission must be selected (permissions cannot be 0)"
                invalid_permissions_bitmap:
                  value:
                    error: "Invalid permissions bitmap (valid range: 1-31)"
                permissions_not_integer:
                  value:
                    error: "Permissions must be an integer bitmap"
                rate_limit_invalid:
                  value:
                    error: "Rate limit must be between 0 (unlimited) and 1000"
                rate_limit_not_number:
                  value:
                    error: "Rate limit must be a valid number"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Database error occurred"

  /admin/api/keys/{id}:
    patch:
      tags:
        - Admin API
      summary: Update API key
      description: Update permissions or rate limit for an existing API key
      security:
        - sessionAuth: []
          csrfToken: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: API key ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                permissions:
                  type: integer
                  minimum: 0
                  maximum: 31
                rate_limit:
                  type: integer
                  minimum: 0
              required:
                - permissions
                - rate_limit
      responses:
        '200':
          description: API key updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: API key not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Admin API
      summary: Delete API key
      description: Permanently delete an API key
      security:
        - sessionAuth: []
          csrfToken: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: API key ID
      responses:
        '200':
          description: API key deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: API key not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/api/keys/{id}/toggle:
    post:
      tags:
        - Admin API
      summary: Toggle API key status
      description: Activate or deactivate an API key
      security:
        - sessionAuth: []
          csrfToken: []
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: API key ID
      responses:
        '200':
          description: API key toggled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/api/keys/bulk:
    post:
      tags:
        - Admin API
      summary: Bulk key operations
      description: Perform bulk operations on multiple API keys
      security:
        - sessionAuth: []
          csrfToken: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [delete, activate, deactivate]
                  description: Action to perform
                key_ids:
                  type: array
                  items:
                    type: integer
                  description: List of API key IDs
              required:
                - action
                - key_ids
      responses:
        '200':
          description: Bulk operation completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/api/logs:
    get:
      tags:
        - Admin API
      summary: Get application logs
      description: |
        Retrieve application logs for monitoring and debugging.
        
        **Note:** Logs are returned in reverse chronological order (newest first).
        This ensures that when fetching the default or maximum number of lines,
        you receive the most recent log entries.
      security:
        - sessionAuth: []
        - bearerAuth: []
      parameters:
        - name: file
          in: query
          required: false
          schema:
            type: string
          description: Specific log file name (optional, defaults to current log)
        - name: lines
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 10000
            default: 1000
          description: Number of log lines to retrieve (1-10000, default 1000)
      responses:
        '200':
          description: Log data
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      type: string
                    description: Array of log lines in reverse chronological order (newest first)
                  loggers:
                    type: array
                    items:
                      type: string
                    description: List of logger names found in logs
                  lines_returned:
                    type: integer
                    description: Actual number of lines returned
                    example: 1000
                  lines_requested:
                    type: integer
                    description: Number of lines requested
                    example: 1000
                  note:
                    type: string
                    description: Information about log ordering
                    example: "Logs are returned in reverse chronological order (newest first)"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/api/logs/list:
    get:
      tags:
        - Admin API
      summary: List available log files
      description: Get a list of all available log files
      security:
        - sessionAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: List of log files
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        size:
                          type: integer
                          description: File size in bytes
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/api/logs/download:
    get:
      tags:
        - Admin API
      summary: Download log file
      description: Download a log file
      security:
        - sessionAuth: []
        - bearerAuth: []
      parameters:
        - name: file
          in: query
          required: false
          schema:
            type: string
          description: Specific log file name (optional, defaults to current log)
      responses:
        '200':
          description: Log file
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Webhook Endpoint
  /webhook:
    post:
      tags:
        - Webhooks
      summary: GitHub webhook receiver
      description: |
        Receives GitHub webhook events for star and watch actions.
        
        ### Setup Instructions:
        1. Go to your GitHub repository Settings â†’ Webhooks
        2. Click "Add webhook"
        3. Set Payload URL: `https://your-domain.com/webhook`
        4. Content type: `application/json`
        5. Secret: Use the secret from `/api/generate-secret`
        6. Select events: **Stars** and **Watches**
        7. Click "Add webhook"
        
        The application will verify the signature and send Discord notifications
        for first-time interactions only.
      parameters:
        - name: X-GitHub-Event
          in: header
          required: true
          schema:
            type: string
            enum: [star, watch]
          description: GitHub event type
        - name: X-Hub-Signature-256
          in: header
          required: true
          schema:
            type: string
          description: HMAC SHA-256 signature of the payload
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: GitHub webhook payload (format varies by event type)
      responses:
        '200':
          description: Event processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Notification sent"
        '400':
          description: Bad request - Invalid payload or missing headers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - Invalid signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Repository not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
